#! /usr/bin/env nix-shell
#! nix-shell -i bash -p curl
# shellcheck shell=bash
set -euo pipefail

echo -n "Latitude: "
read latitude

echo -n "Longitude: "
read longitude

echo -n "Elevation: "
read elevation

echo -n "deCONZ User: "
read deconzAdminUser

echo -n "deCONZ Pass: "
read -s deconzAdminPass
echo

deconzAuth=$(echo "$deconzAdminUser:$deconzAdminPass" | base64)

deconzSecret=$(curl \
  -X POST \
  -H "Content-Type: application/json" \
  -H "Authorization: Basic $deconzAuth" \
  -d '{"devicetype": "Home Assistant"}' localhost:8080/api)

cat <<EOF
{
  deployment.keys.hass-secrets.text = builtins.toJSON {
    latitude = $latitude;
    longitude = $longitude;
    elevation = $elevation;
    deconzSecret = "$deconzSecret";
  };
}
